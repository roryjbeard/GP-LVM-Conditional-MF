\documentclass[12pt]{article}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage[top=20mm, bottom=20mm, left=30mm, right=30mm]{geometry}
\usepackage{soul}
\usepackage{bbm}
%Gummi|061|=)
\usepackage{setspace}
\usepackage[usenames, dvipsnames]{color}

\newcommand{\chris}[1]{\textcolor{ForestGreen}{#1}}
\newcommand{\Tau}{\mathcal{T}}
\newcommand{\Kappa}{\mathcal{K}}
\newcommand{\xb}{\mathbf{x}}
\newcommand{\ub}{\mathbf{u}}
\newcommand{\zb}{\mathbf{z}}
\newcommand{\fb}{\mathbf{f}}
\newcommand{\Cb}{\mathbf{C}}
\newcommand{\Ab}{\mathbf{A}}
\newcommand{\yb}{\mathbf{y}}
\newcommand{\dd}{\mathrm{d}}
\newcommand{\Lo}{\mathcal{L}_1}
\newcommand{\Laux}{\mathcal{L}_{\mathrm{aux}}}
\newcommand{\Kff}{\mathbf{K}_{ff}}
\newcommand{\Kuu}{\mathbf{K}_{uu}}
\newcommand{\Kuf}{\mathbf{K}_{uf}}
\newcommand{\Kfu}{\mathbf{K}_{fu}}
\newcommand{\Ex}{\mathbb{E}}
\newcommand{\KL}{\mathrm{KL}}
\newcommand{\No}{\mathcal{N}}
\newcommand{\chol}{\mathrm{chol}}
\newcommand{\tr}{\mathrm{tr}}
\doublespacing

\setlength{\parindent}{0pt}

\title{\textbf{Derivations and Equations}}
\date{}
\begin{document}

\maketitle


\section{Deriving the bound} % (fold)
\label{sec:derive_bound}
The standard variational formulation is
%
\begin{align}
    \log p(\yb) &= \int q(\zb)\log\frac{p(\yb|\zb)p(\zb)}{q(\zb)}\frac{q(\zb)}{p(\zb|\yb)} \dd\zb\notag\\
    &= \underbrace{\mathbb{E}_{q(\zb)}\big[ \log p(\yb|\zb)p(\zb) - \log q(\zb) \big]}_{\Lo} + \KL\big[ q(\zb)\Vert p(\zb|\yb) \big]\label{eq:logpy1}
\end{align}

We want $\fb = f(X_f)$ to come from a Guassian process. We also want to condition that GP on some $\ub=u(X_u)$ who's distribution, $q(\ub)$, we control.

We want $u$ and $f$ to come from the same zero mean gaussian process
%
\begin{equation}
    [f(X_f),u(X_u)]^\top \sim \mathcal{GP}(0,[K(X_f,X_f^\prime),K(X_f,X_u^\prime);K(X_u,X_f^\prime),K(X_u,X_u^\prime)])
\end{equation}
%
where $K(X_f,X_f^\prime) = \Kff$, $K(X_f,X_u^\prime) = \Kfu$, $ K(X_u,X_f^\prime) = \Kuf$, $K(X_u,X_u^\prime) = \Kuu$.

Therefore $\fb|\ub,X_f,X_u \sim \mathcal{N}(\Kfu\Kuu^{-1}\ub, \Kff - \Kfu\Kuu^{-1}\Kuf)$

We also want to treat the input locations $X_f$ as random variables with distribution $q(X_f)$ who's parameters we control.
%
\begin{align}
q(\zb|\yb) &= \int_{\ub,\fb,X_f} q(\zb|\fb, \yb)q(\fb|\ub,X_f)q(\ub)q(X_f|\yb) \dd\ub \dd\fb \dd X_f \label{eq:qz1} \\
&= \frac{q(\zb |\fb, \yb)q(\fb|\ub,X_f)q(\ub)q(X_f|\yb)}{q(\fb,\ub,X_f|\zb,\yb)} \label{eq:qz2}
\end{align}
%
Note that the integral
%
\begin{equation}
\int_{\ub} q(\fb|\ub,X_f)q(\ub)q(X_f|\yb) \dd\ub
\end{equation}
%
is tractable but the integral
\begin{equation}
\int_{X_f} q(\fb|\ub,X_f)q(\ub)q(X_f|\yb) \dd X_f
\end{equation}
%
is not.
%
Re-writing $\Lo$ replacing the $q(\zb)$ in the expectation with Equation \ref{eq:qz1} and in the logarithm with Equation \ref{eq:qz2} gives.
%
\begin{align}
\Lo &= \Ex_{q(\zb,\fb,\ub,X_f)}[\log p(\yb|\zb)p(\zb)] - \Ex_{q(\zb,\fb,\ub,X_f)}\left[\log\frac{q(\zb |\fb, \yb)q(\fb|\ub,X_f)q(\ub)q(X_f|\yb)}{q(\fb,\ub,X_f|\zb,\yb)}\right]
\end{align}
%
This contains a term $q(\fb,\ub,X_f|\zb,\yb)$, that we cannot obtain so we first factorise it as $q(\ub|\fb, X_f, \zb)q(\fb,X_f | \zb,\yb)$, the first term of which is tractable and then we introduce $r(\fb,X_f|\zb,\yb)$ that will approximate the second term.
%
\begin{align}
\Lo &= \Ex_{q(\zb,\fb,\ub,X_f|\yb)}[\log p(\yb|\zb)p(\zb)] - \Ex_{q(\zb,\fb,\ub,X_f|\yb)}\left[\log\frac{q(\zb |\fb, \yb)q(\fb|\ub,X_f)q(\ub)q(X_f|\yb)}{q(\ub|\fb, X_f, \zb)q(\fb,X_f | \zb,\yb)} \frac{r(\fb,X_f|\zb,\yb)}{r(\fb,X_f|\zb,\yb)}\right] \\
&= \Ex_{q(\zb,\fb,\ub,X_f|\yb)}[\log p(\yb|\zb)] - \Ex_{q(\zb,\fb,\ub,X_f|\yb)}\left[\log\frac{q(\zb|\fb,\yb)}{p(\zb)}\right] \notag \\
&-\Ex_{q(\zb,\fb,\ub,X_f|\yb)}\left[\log\frac{q(\fb|\ub,X_f)q(X_f|\yb)}{r(\fb,X_f|\zb,\yb)}\right] + \Ex_{q(\zb,\fb,X_f|\yb)}\left[\log\frac{q(\fb,X_f|\zb,\yb)}{r(\fb,X_f|\zb,\yb)}\right] \\
&= \Ex_{q(\zb,\fb,\ub,X_f|\yb)}[\log p(\yb|\zb)] - \Ex_{q(\fb,\ub,X_f|\yb)}\left[\Ex_{q(\zb|\fb,\yb)}\left\{\log\frac{q(\zb|\fb,\yb)}{p(\zb)}\right\}\right] \notag \\
&-\Ex_{q(\zb,\fb,\ub,X_f|\yb)}\left[\log\frac{q(\fb|\ub,X_f)q(X_f|\yb)}{r(\fb,X_f|\zb,\yb)}\right] + \Ex_{q(\zb|\yb)}\left[\Ex_{q(\fb,X_f|\zb,\yb)}\left\{\log\frac{q(\fb,X_f|\zb,\yb)}{r(\fb,X_f|\zb,\yb)}\right\}\right] \\
&= \Ex_{q(\zb,\fb,\ub,X_f|\yb)}[\log p(\yb|\zb)] - \Ex_{q(\fb,\ub,X_f|\yb)}\left[\KL\left(q(\zb|\fb,\yb)||p(\zb)\right)\right] \notag \\
&-\Ex_{q(\zb,\fb,\ub,X_f|\yb)}\left[\log\frac{q(\fb|\ub,X_f)q(X_f|\yb)}{r(\fb,X_f|\zb,\yb)}\right] + \Ex_{q(\zb|\fb,\ub,X_f,\yb)}\left[\KL\left(q(\fb,X_f|\zb,\yb)||r(\fb,X_f|\zb,\yb)\right)\right]
\end{align}
%
Noticing the final KL divergence term is always positive we can drop this term to obtain a lower bound $\Laux:$
%
\begin{align}
\Lo &\ge \Ex_{q(\zb)}[\log p(\yb|\zb)] - \Ex_{q(\ub,X_z)}\left[\KL\left(q(\zb|\ub,X_z)||p(\zb)\right)\right] \notag \\
&-\Ex_{q(\ub)}\left[\log q(\ub)\right] - \Ex_{q(X_z)}\left[\log q(X_z)\right] + \Ex_{q(\zb,\ub,X_z)}\left[\log r(\ub,X_z|\zb)\right] \\
&\triangleq \Laux
\end{align}
%

\begin{align}
p(\zb) &= \prod_{q=1}^Q \mathcal{N}(\zb_q; \vec{0}, \mathbb{I}_B) \\
q(\ub) &= \prod_{q=1}^Q \mathcal{N}(\ub_q; \kappa_q, \Kappa) \\
q(\zb|\ub,X_z) &= \prod_{q=1}^Q \mathcal{N}(\zb_q; \underbrace{\Kfu\Kuu^{-1}}_{\Ab}\ub_q, \underbrace{\Kff-\Kfu\Kuu^{-1}\Kuf}_{\Cb}) \\
q(X_f) &= \prod_{r=1}^R \mathcal{N}(\xb_r; \phi_r, \Phi)
\end{align}
%
\begin{align}
&\Ex_{q(\ub,X_z)}\left[\KL\left(q(\zb|\ub,X_z)||p(\zb)\right)\right] \notag \\
&= \Ex_{q(\ub,X_z)}\left[\frac{1}{2}\sum_{q=1}^Q \left(\tr(\Cb) + \zb_q^\top\zb - B -  \log\det\Cb \right)\right] \\
&= \Ex_{q(\ub,X_z)}\left[\frac{1}{2}\sum_{q=1}^Q \left(\tr(\Cb) + \ub_q^\top\Ab^\top\Ab\ub_q - B -  \log\det\Cb \right)\right] \\
&=\Ex_{q(X_z)}\left[\frac{1}{2}\sum_{q=1}^Q \left(\tr(\Cb) + \Ex_{q(\ub_z)}[\tr(\Ab^\top\Ab\ub_q\ub_q^\top)] - B -  \log\det\Cb \right)\right] \\
&=\Ex_{q(X_z)}\left[\frac{Q}{2}\tr(\Cb) + \frac{1}{2}\sum_{q=1}^Q\;\tr(\Ab^\top\Ab\kappa_q\kappa_q^\top) + \frac{Q}{2}\;\tr(\Ab^\top\Ab\Kappa) - \frac{QB}{2} -  \frac{Q}{2}\;\log\det\Cb \right] \\
&=\Ex_{q(X_z)}\left[\frac{Q}{2}\tr(\Cb) + \frac{1}{2}\;\tr(\Ab^\top\Ab\kappa\kappa^\top) + \frac{Q}{2}\;\tr(\Ab^\top\Ab\Kappa) - \frac{QB}{2} -  \frac{Q}{2}\;\log\det\Cb \right]
\end{align}
%
The entropy of $q(\ub)$ is:
%
\begin{align}
-\Ex_{q(\ub)}\left[\log q(\ub)\right] &= \sum_{q=1}^Q H[q(\ub_q)] \\
&= \frac{MQ}{2}(1+\log(2\pi))) + \frac{Q}{2}\log\det(\Kappa)
\end{align}
%
The entropy of $q(X_z)$ is:
%
\begin{align}
-\Ex_{q(X_z)}\left[\log q(\ub)\right] &= \sum_{r=1}^R H[q(\xb_r)] \\
&= \frac{RB}{2}(1+\log(2\pi))) + \frac{R}{2}\log\det(\Phi)
\end{align}
%
We decompose $r$ as $r(\ub,X_z|\zb) = r(\ub|\zb,X_z)r(X_z|\zb)$.
%
\begin{align}
\Ex_{q(\zb,\ub,X_z)}\left[\log r(\ub,X_z|\zb)\right] &= \Ex_{q(\zb,\ub,X_z)}\left[\log r(\ub|X_z,\zb)\right] + \Ex_{q(\zb,X_z)}\left[\log r(X_z|\zb)\right]
\end{align}
%
We set $r(\ub|\zb,X_z) = q(\ub|\zb,X_z)$ which we can compute exactly.
%
\begin{align}
q(\ub|\zb,X_z) &= \prod_{q=1}^Q \mathcal{N}(\ub_q; \upsilon_q, \Upsilon) \\
%\Cb^{-1} &= [\Kzz^{-1}-\Kzz^{-1}\Kzu\{ \Kuz\Kzz^{-1}\Kzu-\Kuu\}^{-1}\Kuz\Kzz^{-1} ] \\
\Upsilon &= (\Kappa^{-1} + \Ab^\top\Cb^{-1}\Ab)^{-1} \\
%&= \Kappa^{-1} - \Kappa^{-1} \Ab^\top (\Cb+ \Ab\Kappa^{-1}\Ab^\top)^{-1}\Ab\Kappa^{-1}\\
\upsilon_q &= (\Kappa^{-1} + \Ab^\top\Cb^{-1}\Ab)^{-1}[\Ab^\top \Cb^{-1}\zb_q + \Kappa^{-1}\kappa_q]
\end{align}
%
Therefore:
%
\begin{align}
\Ex_{q(\zb,\ub,X_z)}\left[\log r(\ub|X_z,\zb)\right] &= \Ex_{q(\zb,X_z)}\left[ \Ex_{q(\ub|\zb,X_z)} \left\{\log q(\ub|\zb,X_z) \right\} \right] \\
&= \Ex_{q(\zb,X_z)}\left[-H(q(\ub|\zb,X_z)) \right] \\
&= \Ex_{q(X_z)}\left[-\frac{MQ}{2}(1+\log(2\pi))) -\frac{Q}{2}\log\det(\Upsilon) \right]
\end{align}
%


\end{document}


